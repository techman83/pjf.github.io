<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Powershell + Windows Update - Techman83's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://techman83.me/img/favicon.png" rel="icon">

<link rel="canonical" href="https://techman83.me/programming/2015/06/09/powershell.html">

        <meta name="author" content="Leon Wright" />
        <meta name="keywords" content="programming,powershell,windows,update,win10" />
        <meta name="description" content="Windows administration is part of my job that I don&#39;t enjoy as much as linux, but it is still necessary. Though Windows is becoming less and less required, a lot of software still relies on it. Microsoft to their credit are making an effort to shift people onto their new …" />

        <meta property="og:site_name" content="Techman83's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Powershell + Windows Update"/>
        <meta property="og:url" content="https://techman83.me/programming/2015/06/09/powershell.html"/>
        <meta property="og:description" content="Windows administration is part of my job that I don&#39;t enjoy as much as linux, but it is still necessary. Though Windows is becoming less and less required, a lot of software still relies on it. Microsoft to their credit are making an effort to shift people onto their new …"/>
        <meta property="article:published_time" content="2015-06-09" />
            <meta property="article:section" content="programming" />
            <meta property="article:tag" content="programming" />
            <meta property="article:tag" content="powershell" />
            <meta property="article:tag" content="windows" />
            <meta property="article:tag" content="update" />
            <meta property="article:tag" content="win10" />
            <meta property="article:author" content="Leon Wright" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://techman83.me/theme/css/bootstrap.spacelab.min.css" type="text/css"/>
    <link href="https://techman83.me/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://techman83.me/theme/css/pygments/vim.css" rel="stylesheet">
    <link href="https://techman83.me/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://techman83.me/theme/css/style.css" type="text/css"/>
        <link href="https://techman83.me/./css/style.min.css" rel="stylesheet">

        <link href="https://techman83.me/feeds/all-atom.xml" type="application/atom+xml" rel="alternate"
              title="Techman83's Blog ATOM Feed"/>

        <link href="https://techman83.me/feeds/all-rss.xml" type="application/rss+xml" rel="alternate"
              title="Techman83's Blog RSS Feed"/>


        <link href="https://techman83.me/feeds/programming-atom.xml" type="application/atom+xml" rel="alternate"
              title="Techman83's Blog programming ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://techman83.me/" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="https://techman83.me/img/favicon.png" width=""/> Techman83's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://techman83.me/hardware">Hardware</a>
                        </li>
                        <li >
                            <a href="https://techman83.me/personal">Personal</a>
                        </li>
                        <li class="active">
                            <a href="https://techman83.me/programming">Programming</a>
                        </li>
                        <li >
                            <a href="https://techman83.me/talks">Talks</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://techman83.me/programming/2015/06/09/powershell.html"
                       rel="bookmark"
                       title="Permalink to Powershell + Windows Update">
                        Powershell + Windows Update
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2015-06-09T00:00:00+08:00"> Tue 09 June 2015</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://techman83.me/tag/programming.html">programming</a>
        /
	<a href="https://techman83.me/tag/powershell.html">powershell</a>
        /
	<a href="https://techman83.me/tag/windows.html">windows</a>
        /
	<a href="https://techman83.me/tag/update.html">update</a>
        /
	<a href="https://techman83.me/tag/win10.html">win10</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>Windows administration is part of my job that I don't enjoy as much as linux, but it is still necessary. Though Windows is becoming less and less required, a lot of software still relies on it. </p>
<p>Microsoft to their credit are making an effort to shift people onto their new OS before it becomes another Windows XP situation (Released in 2001, 4 OS' released in that time and it is still being used in a lot of places). However they seemed to have failed restricting the updates to Consumer machines only. </p>
<p>Having the update deploy to coporate machines (I've seen reports of it happening on Domain joined and Volume licensed machines) is all rather annoying and removing them only means they have a chance to come back next time the user updates. In an ideal world you'd use WSUS, but with a geographically disperse workforce often working in remote locations this isn't practical.</p>
<p>Enter <a href="https://gallery.technet.microsoft.com/scriptcenter/2d191bcd-3308-4edd-9de2-88dff796b0bc/">PSWindowsUpdate</a>. Now it didn't work on powershell 2.0 without a slight modification</p>
<p>PSWindowsUpdate.psm1 - It's top comment on one of the threads, If I remember where I'll make the attribution.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nv">$PSVersionTable</span><span class="p">.</span><span class="n">PSVersion</span><span class="p">.</span><span class="n">tostring</span><span class="p">()</span> <span class="o">-ge</span> <span class="n">4</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$PSScriptRoot</span> <span class="p">|</span> <span class="n">Unblock</span><span class="o">-File</span>
<span class="p">}</span>
<span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$PSScriptRoot</span><span class="p">\*.</span><span class="n">ps1</span> <span class="p">|</span> <span class="k">Foreach</span><span class="n">-Object</span><span class="p">{</span> <span class="p">.</span> <span class="nv">$_</span><span class="p">.</span><span class="n">FullName</span> <span class="p">}</span>
</pre></div>


<p>I also removed the confirmation around the uninstall (I think it's just missing the argument to ignore it, but It was quicker for me just to remove it):</p>
<p>Get-WUUninstall.ps1 with confirmation removed from "Process', also added '/quiet /norestart'</p>
<div class="codehilite"><pre><span></span><span class="k">Process</span>
<span class="p">{</span>    
      <span class="k">If</span><span class="p">(</span><span class="nv">$KBArticleID</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="nv">$KBArticleID</span> <span class="p">=</span> <span class="nv">$KBArticleID</span> <span class="o">-replace</span> <span class="s2">&quot;KB&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

          <span class="n">wusa</span> <span class="p">/</span><span class="n">uninstall</span> <span class="p">/</span><span class="n">kb</span><span class="err">:</span><span class="nv">$KBArticleID</span> <span class="p">/</span><span class="n">quiet</span> <span class="p">/</span><span class="n">norestart</span>
      <span class="p">}</span> <span class="c">#End If $KBArticleID</span>
      <span class="k">Else</span>
      <span class="p">{</span>
          <span class="n">wmic</span> <span class="n">qfe</span> <span class="n">list</span>
      <span class="p">}</span> <span class="c">#End Else $KBArticleID</span>
<span class="p">}</span> <span class="c">#End Process</span>
</pre></div>


<p>This is what I came up with and it appears to work well enough. It could use some extra checking and polishing, but we will have auto deploy and also as a utility app. If someone mentions it, they can be instructed to re-run it and it will try again. Also that's about as much time I wish to spend doing anything in powershell!</p>
<div class="codehilite"><pre><span></span><span class="nb">Import-Module</span> <span class="n">PSWindowsUpdate</span>

<span class="nv">$ServiceID</span> <span class="p">=</span> <span class="nb">Get-WUServiceManager</span><span class="p">|</span> <span class="n">Select</span> <span class="n">ServiceID</span>

<span class="c"># KB3035583 - GWX - Get Windows 10 AdWare</span>
<span class="c"># KB2952664 - Compatibility Update for Upgrading Win 7 to Win 10</span>
<span class="c"># KB3021917 - Phones Home to tell MS how your computer will perform with Win 10</span>

<span class="nv">$kbIDs</span> <span class="p">=</span> <span class="s2">&quot;KB3035583&quot;</span><span class="p">,</span><span class="s2">&quot;KB2952664&quot;</span><span class="p">,</span><span class="s2">&quot;KB3021917&quot;</span>

<span class="nv">$installed</span> <span class="p">=</span> <span class="nb">Get-WUList</span> <span class="n">-ServiceID</span> <span class="nv">$ServiceID</span> <span class="n">-IsInstalled</span> <span class="n">-KBArticleID</span> <span class="nv">$kbIDs</span> <span class="p">|</span> <span class="n">Select</span> <span class="n">KB</span>

<span class="k">if</span> <span class="p">(</span><span class="nv">$installed</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">write-host</span> <span class="s2">&quot;We have some crud to remove&quot;</span>
    <span class="nb">Write-Host</span> <span class="nv">$installed</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$update</span> <span class="k">in</span> <span class="nv">$installed</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;Removing &quot;</span> <span class="nv">$update</span><span class="p">.</span><span class="n">KB</span>
        <span class="nb">Get-WUUninstall</span> <span class="n">-KBArticleID</span> <span class="nv">$update</span><span class="p">.</span><span class="n">KB</span>
        <span class="nb">Start-Sleep</span> <span class="n">-s</span> <span class="n">10</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">write-host</span> <span class="s2">&quot;We&#39;re Crap free&quot;</span>
<span class="p">}</span>

<span class="nb">Start-Sleep</span> <span class="n">-s</span> <span class="n">10</span>

<span class="nv">$tohide</span> <span class="p">=</span> <span class="nb">Get-WUList</span> <span class="n">-ServiceID</span> <span class="nv">$ServiceID</span> <span class="n">-KBArticleID</span> <span class="nv">$kbIDs</span> <span class="n">-IsNotHidden</span>

<span class="k">if</span> <span class="p">(</span> <span class="nv">$tohide</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">Write-Host</span> <span class="s2">&quot;Hide ALL the CRAP!!!&quot;</span>
    <span class="nb">Write-Host</span> <span class="p">(</span><span class="nv">$tohide</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="p">|</span> <span class="nb">Out-String</span><span class="p">)</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$hide</span> <span class="k">in</span> <span class="nv">$tohide</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">Write-Host</span> <span class="s2">&quot;Hiding &quot;</span> <span class="nv">$hide</span><span class="p">.</span><span class="n">KB</span>
        <span class="nb">Write-Host</span> <span class="p">(</span><span class="nv">$hide</span> <span class="p">|</span> <span class="nb">Format-Table</span> <span class="p">|</span> <span class="nb">Out-String</span><span class="p">)</span>
        <span class="nv">$hide</span><span class="p">.</span><span class="n">IsHidden</span> <span class="p">=</span> <span class="nv">$true</span>
        <span class="nb">Start-Sleep</span> <span class="n">-s</span> <span class="n">10</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Things to note:</p>
<ul>
<li>Get-WUList seems to take forever.</li>
<li>Get-WUList seems won't show what's current until after a reboot (some updates require a reboot and seem to not change their installed state until done).</li>
<li>You can iterate of an object or an array, but if your object is an array and you don't loop over it you'll be left scratching your head.</li>
</ul>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://techman83.me/programming/2014/08/04/jira_automation.html">Jira Automation + Copying Fields</a></li>
        <li><a href="https://techman83.me/hardware/2017/06/04/dont_underestimate_the_doorbell.html">Don't underestimate the... Doorbell</a></li>
        <li><a href="https://techman83.me/programming/2014/08/26/webservice_strava.html">WebService::Strava - A Strava API Perl Client</a></li>
        <li><a href="https://techman83.me/talks/2018/01/22/come_on_do_you_want_your_mods_to_live_forever.html">Come on; do you want your mods to live forever?</a></li>
        <li><a href="https://techman83.me/programming/2014/01/20/eventstreamr.html">Automating AV&#58; EventStreamr</a></li>
    </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_share" fb:share:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
<div class="tip-box">
    <p>
        <a href="https://www.gittip.com/techman83/"><i class="fa fa-gittip fa-3x pull-left"></i></a>
    This content is available for you to use for free,
            even commercially, under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.">Creative Commons Attribution 4.0 International License</a>
    </p><p>
        If you wish to support my work,
        please <a href="https://www.gittip.com/techman83/">tip me on gittip</a>.
    </p>
</div>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'techman83'; // required: replace example with your forum shortname

                    var disqus_identifier = 'powershell';
                var disqus_url = 'https://techman83.me/programming/2015/06/09/powershell.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://techman83.me/img/leon-vr.png"/>
        </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
        <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/Techman83"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/Techman_83"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>






    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://pjf.github.io" target="_blank">
                PJF
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://superhouse.tv" target="_blank">
                Superhouse.tv
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://bigclive.com" target="_blank">
                Big Clive
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Leon Wright
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://techman83.me/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://techman83.me/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://techman83.me/theme/js/respond.min.js"></script>

    <script src="https://techman83.me/./js/compiled-bundle.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://techman83.me/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'techman83',
                count: 4,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://techman83.me/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'techman83'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-39211824-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52df33e30fca36e7"></script>
</body>
</html>