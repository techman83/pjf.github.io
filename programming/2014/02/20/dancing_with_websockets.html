<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Dancing with WebSockets - Techman83's Blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="https://techman83.me/img/favicon.png" rel="icon">

<link rel="canonical" href="https://techman83.me/programming/2014/02/20/dancing_with_websockets.html">

        <meta name="author" content="Leon Wright" />
        <meta name="keywords" content="programming,perl,dancer,websockets" />
        <meta name="description" content="I learnt during the development of the EventStreamR frontend that websockets are cool! Another learning project of mine is NanodeControl and after learning what all the cool new things are available I wanted to have a crack at making it more modern. After a bit of search around I came …" />

        <meta property="og:site_name" content="Techman83's Blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Dancing with WebSockets"/>
        <meta property="og:url" content="https://techman83.me/programming/2014/02/20/dancing_with_websockets.html"/>
        <meta property="og:description" content="I learnt during the development of the EventStreamR frontend that websockets are cool! Another learning project of mine is NanodeControl and after learning what all the cool new things are available I wanted to have a crack at making it more modern. After a bit of search around I came …"/>
        <meta property="article:published_time" content="2014-02-20" />
            <meta property="article:section" content="programming" />
            <meta property="article:tag" content="programming" />
            <meta property="article:tag" content="perl" />
            <meta property="article:tag" content="dancer" />
            <meta property="article:tag" content="websockets" />
            <meta property="article:author" content="Leon Wright" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="https://techman83.me/theme/css/bootstrap.spacelab.min.css" type="text/css"/>
    <link href="https://techman83.me/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="https://techman83.me/theme/css/pygments/vim.css" rel="stylesheet">
    <link href="https://techman83.me/theme/tipuesearch/tipuesearch.css" rel="stylesheet">
    <link rel="stylesheet" href="https://techman83.me/theme/css/style.css" type="text/css"/>
        <link href="https://techman83.me/./css/style.min.css" rel="stylesheet">

        <link href="https://techman83.me/feeds/all-atom.xml" type="application/atom+xml" rel="alternate"
              title="Techman83's Blog ATOM Feed"/>

        <link href="https://techman83.me/feeds/all-rss.xml" type="application/rss+xml" rel="alternate"
              title="Techman83's Blog RSS Feed"/>


        <link href="https://techman83.me/feeds/programming-atom.xml" type="application/atom+xml" rel="alternate"
              title="Techman83's Blog programming ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://techman83.me/" class="navbar-brand">
<img class="img-responsive pull-left gap-right" src="https://techman83.me/img/favicon.png" width=""/> Techman83's Blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li >
                            <a href="https://techman83.me/hardware">Hardware</a>
                        </li>
                        <li >
                            <a href="https://techman83.me/personal">Personal</a>
                        </li>
                        <li class="active">
                            <a href="https://techman83.me/programming">Programming</a>
                        </li>
                        <li >
                            <a href="https://techman83.me/talks">Talks</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><span>
                <form class="navbar-search" action="/search.html">
                  <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input" required>
                </form></span>
              </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="https://techman83.me/programming/2014/02/20/dancing_with_websockets.html"
                       rel="bookmark"
                       title="Permalink to Dancing with WebSockets">
                        Dancing with WebSockets
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2014-02-20T00:00:00+08:00"> Thu 20 February 2014</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="https://techman83.me/tag/programming.html">programming</a>
        /
	<a href="https://techman83.me/tag/perl.html">perl</a>
        /
	<a href="https://techman83.me/tag/dancer.html">dancer</a>
        /
	<a href="https://techman83.me/tag/websockets.html">websockets</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>I learnt during the development of the <a href="https://github.com/plugorgau/eventstreamr">EventStreamR</a> frontend that websockets are cool! Another learning project of mine is <a href="https://github.com/techman83/NanodeControl">NanodeControl</a> and after learning what all the cool new things are available I wanted to have a crack at making it more modern.</p>
<p>After a bit of search around I came across <a href="http://search.cpan.org/~ironcamel/Dancer-Plugin-WebSocket-0.0100/lib/Dancer/Plugin/WebSocket.pm">Dancer::Plugin::WebSocket</a>. Expanding on the example provided here is a simple web page with simple messages and forked calls. It utilises the the Twiggy AnyEvent based non-blocking (asynchronous) and lightweight PSGI web server.</p>
<p>You'll need some libraries, my favourite way to install them is <a href="http://search.cpan.org/~miyagawa/App-cpanminus-1.7001/lib/App/cpanminus.pm">cpanm</a>:</p>
<div class="codehilite"><pre><span></span>cpanm -S Plack Twiggy Dancer Dancer::Plugin::WebSocket AnyEvent::Util
</pre></div>


<p>app.pl:</p>
<div class="codehilite"><pre><span></span><span class="k">use</span> <span class="n">Dancer</span> <span class="s">&#39;:syntax&#39;</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">Dancer::Plugin::</span><span class="n">WebSocket</span><span class="p">;</span>
<span class="k">use</span> <span class="nn">AnyEvent::</span><span class="n">Util</span><span class="p">;</span>

<span class="n">set</span> <span class="n">logger</span> <span class="o">=&gt;</span> <span class="s">&#39;console&#39;</span><span class="p">;</span>
<span class="n">set</span> <span class="nb">log</span> <span class="o">=&gt;</span> <span class="s">&#39;core&#39;</span><span class="p">;</span>

<span class="n">get</span> <span class="s">&#39;/&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span><span class="sx">q[</span>
<span class="sx">    &lt;html&gt;</span>
<span class="sx">    &lt;head&gt;</span>
<span class="sx">    &lt;script&gt;</span>
<span class="sx">      var ws_path = &quot;ws://localhost:5000/_hippie/ws&quot;;</span>
<span class="sx">      var socket = new WebSocket(ws_path);</span>
<span class="sx">      socket.onopen = function() {</span>
<span class="sx">          document.getElementById(&#39;conn-status&#39;).innerHTML = &#39;Connected&#39;;</span>
<span class="sx">      };</span>
<span class="sx">      socket.onmessage = function(e) {</span>
<span class="sx">          var data = JSON.parse(e.data);</span>
<span class="sx">          console.log(data);</span>
<span class="sx">          if (data.msg) {</span>
<span class="sx">            document.getElementById(&#39;content&#39;).innerHTML = data.msg;</span>
<span class="sx">            setTimeout(function() {</span>
<span class="sx">              document.getElementById(&#39;content&#39;).innerHTML = &#39;No current message&#39;;</span>
<span class="sx">            }, 5000);</span>
<span class="sx">          }</span>
<span class="sx">      };</span>
<span class="sx">      function send_msg(message) {</span>
<span class="sx">          socket.send(JSON.stringify({ msg: message }));</span>
<span class="sx">      }</span>
<span class="sx">      function get_long() {</span>
<span class="sx">        var xmlHttp = null;</span>

<span class="sx">        xmlHttp = new XMLHttpRequest();</span>
<span class="sx">        xmlHttp.open( &quot;GET&quot;, &#39;/long&#39;, false );</span>
<span class="sx">        xmlHttp.send( null );</span>
<span class="sx">        document.getElementById(&#39;content&#39;).innerHTML = &#39;Waiting...&#39;;</span>
<span class="sx">      }</span>
<span class="sx">    &lt;/script&gt;</span>
<span class="sx">    &lt;/head&gt;</span>
<span class="sx">    &lt;body&gt;</span>
<span class="sx">    Connection Status: &lt;span id=&quot;conn-status&quot;&gt; Disconnected &lt;/span&gt;</span>
<span class="sx">    &lt;input value=&quot;Send Message&quot; type=button onclick=&quot;send_msg(&#39;hello&#39;)&quot; /&gt;</span>
<span class="sx">    &lt;input value=&quot;Get Long Call&quot; type=button onclick=&quot;get_long()&quot; /&gt;&lt;br&gt;</span>
<span class="sx">    &lt;span id=&quot;content&quot;&gt; No current message &lt;/span&gt;</span>
<span class="sx">    &lt;/body&gt;</span>
<span class="sx">    &lt;/html&gt;</span>
<span class="sx">]</span><span class="p">};</span>

<span class="n">get</span> <span class="s">&#39;/long&#39;</span> <span class="o">=&gt;</span> <span class="k">sub </span><span class="p">{</span>
    <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Stations Called&quot;</span><span class="p">);</span>
    <span class="n">fork_call</span> <span class="p">{</span>
      <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Forking&quot;</span><span class="p">);</span>
      <span class="nb">sleep</span> <span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">sub </span><span class="p">{</span>
      <span class="k">my</span> <span class="nv">$data</span> <span class="o">=</span> <span class="s">&#39;Forked result!&#39;</span><span class="p">;</span>
      <span class="n">ws_send</span> <span class="nv">$data</span><span class="p">;</span>
      <span class="n">debug</span><span class="p">(</span><span class="s">&quot;Message Sent&quot;</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">dance</span><span class="p">;</span>
</pre></div>


<p>Launch the script with plackup:</p>
<div class="codehilite"><pre><span></span>plackup -s Twiggy socket_dance.pl -p 5000
</pre></div>


<p>Browse to http://localhost:5000 and you should be greeted with a page. Press the buttons and watch the magic happen!</p>
<p>I did encounter issues with the latest version of chrome on page refreshes sending bad data crashing twiggy, looks like there are some <a href="https://github.com/miyagawa/Twiggy/pull/39">bug reports</a> indirectly relating to it. However it does work on initial page load and seems to work correctly on firefox :-) </p>
<p>NOTE: I found a solution, instead of using the builtin AnyEvent::Loop, use EV. From what I've read it's a faster and more robust event backend. The errors from chrome still occur, however the server keeps going inside of barfing and dying. As long as EV is available AnyEvent will use it (unless otherwise configured).</p>
            </div>
            <!-- /.entry-content -->
<section class="well" id="related-posts">
    <h4>Related Posts:</h4>
    <ul>
        <li><a href="https://techman83.me/programming/2014/08/26/webservice_strava.html">WebService::Strava - A Strava API Perl Client</a></li>
        <li><a href="https://techman83.me/programming/2014/01/20/eventstreamr.html">Automating AV&#58; EventStreamr</a></li>
        <li><a href="https://techman83.me/programming/2014/08/04/jira_automation.html">Jira Automation + Copying Fields</a></li>
        <li><a href="https://techman83.me/hardware/2017/06/04/dont_underestimate_the_doorbell.html">Don't underestimate the... Doorbell</a></li>
        <li><a href="https://techman83.me/talks/2018/01/22/come_on_do_you_want_your_mods_to_live_forever.html">Come on; do you want your mods to live forever?</a></li>
    </ul>
</section>
    <hr />
    <!-- AddThis Button BEGIN -->
    <div class="addthis_toolbox addthis_default_style">
            <a class="addthis_button_facebook_share" fb:share:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
    </div>
    <!-- AddThis Button END -->
<div class="tip-box">
    <p>
        <a href="https://www.gittip.com/techman83/"><i class="fa fa-gittip fa-3x pull-left"></i></a>
    This content is available for you to use for free,
            even commercially, under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.">Creative Commons Attribution 4.0 International License</a>
    </p><p>
        If you wish to support my work,
        please <a href="https://www.gittip.com/techman83/">tip me on gittip</a>.
    </p>
</div>
    <hr/>
    <section class="comments" id="comments">
        <h2>Comments</h2>

        <div id="disqus_thread"></div>
        <script type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'techman83'; // required: replace example with your forum shortname

                    var disqus_identifier = 'dancing_with_websockets';
                var disqus_url = 'https://techman83.me/programming/2014/02/20/dancing_with_websockets.html';

            var disqus_config = function () {
                this.language = "en";
            };

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function () {
                var dsq = document.createElement('script');
                dsq.type = 'text/javascript';
                dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </section>
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>
<div id="aboutme">
        <p>
            <img width="100%" class="img-thumbnail" src="https://techman83.me/img/leon-vr.png"/>
        </p>
</div>
<section class="well well-sm">
    <ul class="list-group list-group-flush">
        <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/Techman83"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/Techman_83"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>






    <li class="list-group-item"><h4><i class="fa fa-github fa-lg"></i><span class="icon-label">GitHub Repos</span></h4>
        <div id="gh_repos">
            <p class="list-group-item">Status updating...</p>
        </div>
    </li>
    <li class="list-group-item"><h4><i class="fa fa-external-link-square fa-lg"></i><span class="icon-label">Links</span></h4>
      <ul class="list-group" id="links">
        <li class="list-group-item">
            <a href="http://pjf.github.io" target="_blank">
                PJF
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://superhouse.tv" target="_blank">
                Superhouse.tv
            </a>
        </li>
        <li class="list-group-item">
            <a href="http://bigclive.com" target="_blank">
                Big Clive
            </a>
        </li>
      </ul>
    </li>
    </ul>
</section>            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Leon Wright
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>                <p><small>  <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.en"><img alt="Creative Commons License" style="border-width:0" src="//i.creativecommons.org/l/by/4.0/80x15.png" /></a>
    Content
  licensed under a <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.en">Creative Commons Attribution 4.0 International License</a>, except where indicated otherwise.
</small></p>
         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="https://techman83.me/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="https://techman83.me/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="https://techman83.me/theme/js/respond.min.js"></script>

    <script src="https://techman83.me/./js/compiled-bundle.min.js"></script>

    <!-- GitHub JS -->
    <script type="text/javascript">
        $(document).ready(function () {
            if (!window.jXHR) {
                var jxhr = document.createElement('script');
                jxhr.type = 'text/javascript';
                jxhr.src = 'https://techman83.me/theme/js/jXHR.js';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(jxhr, s);
            }

            github.showRepos({
                user: 'techman83',
                count: 4,
                skip_forks: false,
                target: '#gh_repos'
            });
        });
    </script>
    <script src="https://techman83.me/theme/js/github.js" type="text/javascript"></script>
    <!-- End GitHub JS Code -->
    <!-- Disqus -->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'techman83'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script');
            s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <!-- End Disqus Code -->
    <!-- Google Analytics -->
    <script type="text/javascript">

        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-39211824-2']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();
    </script>
    <!-- End Google Analytics Code -->

        <script type="text/javascript">var addthis_config = {"data_track_addressbar": true};</script>
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52df33e30fca36e7"></script>
</body>
</html>